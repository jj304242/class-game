<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ìë¦¬ ë°°ì¹˜ ì•±</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© (Tailwind ê¸°ë³¸) */
        body {
            font-family: "Inter", sans-serif;
        }
        /* ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
        .seat {
            transition: all 0.2s ease-in-out;
        }
        .seat:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .seat.pinned {
            background-color: #dbeafe; /* bg-blue-100 */
            border-color: #60a5fa; /* border-blue-400 */
            font-weight: bold;
        }

        /* ì„ ìƒë‹˜ìš© ë³´ê¸° (ìƒí•˜ ë°˜ì „) ìŠ¤íƒ€ì¼ */
        #seatingChartArea.teachers-view {
            transform: rotate(180deg);
        }
        #seatingChartArea.teachers-view .seat,
        #seatingChartArea.teachers-view .blackboard {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 flex items-center justify-center min-h-screen">

    <div class="bg-white shadow-xl rounded-2xl w-full max-w-6xl p-6 md:p-8">
        <h1 class="text-3xl font-bold text-green-800 mb-6 text-center">ìš°ë¦¬ë°˜ ìë¦¬ ë°°ì¹˜</h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- 1. ì œì–´íŒ (ì…ë ¥) -->
            <div class="lg:col-span-1 p-6 bg-gray-50 rounded-lg shadow-inner">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">ì„¤ì •</h2>
                
                <!-- êµì‹¤ í¬ê¸° -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-2">êµì‹¤ í¬ê¸° (í–‰ x ì—´)</label>
                    <div class="flex gap-4">
                        <input type="number" id="rowsInput" value="5" min="1" max="20" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="í–‰ (Rows)">
                        <input type="number" id="colsInput" value="6" min="1" max="20" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="ì—´ (Cols)">
                    </div>
                </div>

                <!-- í•™ìƒ ëª…ë‹¨ -->
                <div class="mb-4">
                    <label for="studentList" class="block text-sm font-medium text-gray-600 mb-2">í•™ìƒ ëª…ë‹¨</label>
                    <textarea id="studentList" rows="10" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="í•œ ì¤„ì— í•œ ëª…ì”© ì…ë ¥í•˜ì„¸ìš”.&#10;ì—‘ì…€ì—ì„œ ë³µì‚¬/ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥í•©ë‹ˆë‹¤.&#10;---&#10;ê¹€ì² ìˆ˜&#10;ì´ì˜í¬&#10;ë°•ì§€ì„±"></textarea>
                </div>

                <!-- ë³´ê¸° ì „í™˜ -->
                <div class="flex items-center justify-between bg-blue-50 p-3 rounded-md border border-blue-200 mb-4">
                    <label for="teacherViewToggle" class="font-medium text-blue-800">ì„ ìƒë‹˜ìš© ë³´ê¸° (ìƒí•˜ë°˜ì „)</label>
                    <input type="checkbox" id="teacherViewToggle" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="flex flex-col gap-3">
                    <button id="generateGridBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition duration-200 shadow">
                        1. êµì‹¤ ë°°ì¹˜ ìƒì„±
                    </button>
                    <button id="arrangeSeatsBtn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-green-700 transition duration-200 shadow">
                        2. ëœë¤ ìë¦¬ ë°°ì¹˜
                    </button>
                    <button id="downloadPdfBtn" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-purple-700 transition duration-200 shadow">
                        3. PDFë¡œ ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button id="resetBtn" class="w-full bg-gray-500 text-white py-2 px-4 rounded-md font-semibold hover:bg-gray-600 transition duration-200 shadow mt-2">
                        ì´ˆê¸°í™”
                    </button>
                </div>
            </div>

            <!-- 2. ìë¦¬ ë°°ì¹˜ë„ (ì¶œë ¥) -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-lg shadow-inner min-h-[400px]">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-700 text-center">ìë¦¬ ë°°ì¹˜ë„</h2>
                    
                    <!-- PDFë¡œ ìº¡ì²˜í•  ì˜ì—­ -->
                    <div id="seatingChartArea">
                        <!-- êµíƒ -->
                        <div class="blackboard w-2/3 mx-auto bg-gray-700 text-white text-center py-2 rounded-t-lg font-medium shadow-md">
                            êµ íƒ
                        </div>
                        
                        <!-- ìë¦¬ ê·¸ë¦¬ë“œ -->
                        <div id="seatGrid" class="mt-8 grid gap-3 p-2">
                            <!-- JSë¡œ ì¢Œì„ì´ ìƒì„±ë  ê³µê°„ -->
                            <p class="text-gray-500 text-center col-span-full">
                                ë¨¼ì € ì™¼ìª½ ì„¤ì •ì—ì„œ 'êµì‹¤ ë°°ì¹˜ ìƒì„±' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                                <br>
                                ìë¦¬ë¥¼ í´ë¦­í•˜ë©´ í•™ìƒì„ ë¯¸ë¦¬ ê³ ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í•™ìƒ ê³ ì • ëª¨ë‹¬ (ìœ„ì¹˜ ìˆ˜ì • ë° ë²„íŠ¼ ì¶”ê°€) -->
    <div id="pinModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">í•™ìƒ ê³ ì •í•˜ê¸°</h3>
            <p class="mb-2 text-sm">ìë¦¬ <span id="pinSeatLabel" class="font-semibold text-blue-600"></span>ì— ê³ ì •í•  í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.</p>
            
            <input type="hidden" id="pinSeatIdInput">
            
            <select id="pinStudentSelect" class="w-full p-2 border border-gray-300 rounded-md mb-4">
                <!-- JSë¡œ í•™ìƒ ëª©ë¡ì´ ì±„ì›Œì§ˆ ê³µê°„ -->
            </select>
            
            <div class="flex justify-end gap-3">
                <button id="pinCancelBtn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400 transition">
                    ì·¨ì†Œ
                </button>
                <button id="pinRemoveBtn" class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition">
                    ê³ ì • í•´ì œ
                </button>
                <!-- *** ëˆ„ë½ë˜ì—ˆë˜ ë²„íŠ¼ *** -->
                <button id="pinConfirmBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition">
                    ê³ ì •
                </button>
            </div>
        </div>
    </div>


    <script>
        // PDF ë¼ì´ë¸ŒëŸ¬ë¦¬ ì „ì—­ ì°¸ì¡° (UMD ëª¨ë“ˆ ë¡œë“œ)
        const { jsPDF } = window.jspdf;

        document.addEventListener('DOMContentLoaded', () => {
            // DOM ìš”ì†Œ
            const rowsInput = document.getElementById('rowsInput');
            const colsInput = document.getElementById('colsInput');
            const studentList = document.getElementById('studentList');
            const generateGridBtn = document.getElementById('generateGridBtn');
            const arrangeSeatsBtn = document.getElementById('arrangeSeatsBtn');
            const resetBtn = document.getElementById('resetBtn');
            const seatGrid = document.getElementById('seatGrid');
            const teacherViewToggle = document.getElementById('teacherViewToggle');
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
            const seatingChartArea = document.getElementById('seatingChartArea');

            // ëª¨ë‹¬ ìš”ì†Œ
            const pinModal = document.getElementById('pinModal');
            const pinSeatLabel = document.getElementById('pinSeatLabel');
            const pinSeatIdInput = document.getElementById('pinSeatIdInput');
            const pinStudentSelect = document.getElementById('pinStudentSelect');
            const pinConfirmBtn = document.getElementById('pinConfirmBtn');
            const pinCancelBtn = document.getElementById('pinCancelBtn');
            const pinRemoveBtn = document.getElementById('pinRemoveBtn');

            // ì•± ìƒíƒœ
            let students = [];
            let pinnedSeats = {}; // { "seat-0-0": "ê¹€ì² ìˆ˜", "seat-0-1": "ì´ì˜í¬" }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            generateGridBtn.addEventListener('click', createDeskGrid);
            arrangeSeatsBtn.addEventListener('click', assignSeats);
            resetBtn.addEventListener('click', resetAll);
            seatGrid.addEventListener('click', handleSeatClick);
            teacherViewToggle.addEventListener('change', toggleTeacherView);
            downloadPdfBtn.addEventListener('click', downloadAsPdf);
            
            // ëª¨ë‹¬ ë²„íŠ¼ ì´ë²¤íŠ¸
            pinConfirmBtn.addEventListener('click', handlePinConfirm);
            pinRemoveBtn.addEventListener('click', handlePinRemove);
            pinCancelBtn.addEventListener('click', () => pinModal.classList.add('hidden'));

            /**
             * í•™ìƒ ëª…ë‹¨ í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•˜ì—¬ ë°°ì—´ë¡œ ë³€í™˜
             */
            function parseStudentList() {
                const text = studentList.value.trim();
                students = text.split('\n')
                               .map(name => name.trim())
                               .filter(name => name.length > 0);
            }

            /**
             * ì…ë ¥ë°›ì€ í–‰/ì—´ì— ë§ì¶° ì±…ìƒ ê·¸ë¦¬ë“œë¥¼ ìƒì„±
             */
            function createDeskGrid() {
                const rows = parseInt(rowsInput.value);
                const cols = parseInt(colsInput.value);

                if (isNaN(rows) || isNaN(cols) || rows <= 0 || cols <= 0) {
                    // alert() ëŒ€ì‹  ì»¤ìŠ¤í…€ UI/ë©”ì‹œì§€ ì‚¬ìš© ê³ ë ¤ (ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ ìœ ì§€)
                    // ë‹¨, alert()ëŠ” iframe í™˜ê²½ì—ì„œ ë¬¸ì œë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìœ¼ë¯€ë¡œ
                    // console.warnë¡œ ëŒ€ì²´í•˜ê±°ë‚˜ ê°„ë‹¨í•œ ë©”ì‹œì§€ ë°•ìŠ¤ë¥¼ UIì— ì¶”ê°€í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
                    console.warn('ìœ íš¨í•œ í–‰ê³¼ ì—´ì˜ ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                    // ê°„ë‹¨í•œ ë©”ì‹œì§€ í‘œì‹œ
                    seatGrid.innerHTML = '<p class="text-red-500 text-center col-span-full">ìœ íš¨í•œ í–‰ê³¼ ì—´ì˜ ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>';
                    return;
                }

                // ì´ˆê¸°í™”
                seatGrid.innerHTML = '';
                pinnedSeats = {};
                
                seatGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

                for (let i = 0; i < rows; i++) {
                    for (let j = 0; j < cols; j++) {
                        const seatId = `seat-${i}-${j}`;
                        const seat = document.createElement('div');
                        seat.className = "seat border-2 border-gray-300 rounded-lg p-3 min-h-[80px] flex flex-col justify-center items-center bg-gray-50 cursor-pointer"; // justify-between -> justify-center
                        seat.id = seatId;
                        seat.dataset.row = i;
                        seat.dataset.col = j;
                        
                        // 2. í•™ìƒ ì´ë¦„
                        const studentNameEl = document.createElement('span');
                        studentNameEl.className = "student-name font-bold text-lg text-gray-800";
                        studentNameEl.textContent = "---";

                        // 3. ê³ ì • ì•„ì´ì½˜ (ìˆ¨ê²¨ì§„ ìƒíƒœ)
                        const pinIconEl = document.createElement('span');
                        pinIconEl.className = "pin-icon text-sm hidden";
                        pinIconEl.textContent = "ğŸ“Œ";

                        seat.appendChild(studentNameEl);
                        seat.appendChild(pinIconEl);
                        seatGrid.appendChild(seat);
                    }
                }
            }

            /**
             * ì¢Œì„ í´ë¦­ ì‹œ ê³ ì • ëª¨ë‹¬ í‘œì‹œ
             */
            function handleSeatClick(e) {
                const seat = e.target.closest('.seat');
                if (!seat) return;

                const seatId = seat.id;
                // ë°ì´í„° ì†ì„±ì—ì„œ í–‰/ì—´ ì •ë³´ë¥¼ ê°€ì ¸ì™€ ëª¨ë‹¬ìš© ë¼ë²¨ ìƒì„±
                const row = parseInt(seat.dataset.row) + 1;
                const col = parseInt(seat.dataset.col) + 1;
                const seatLabel = `${row}í–‰ ${col}ì—´`;

                // 1. í•™ìƒ ëª©ë¡ íŒŒì‹±
                parseStudentList();
                if (students.length === 0) {
                    // alert('ë¨¼ì € í•™ìƒ ëª…ë‹¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    console.warn('ë¨¼ì € í•™ìƒ ëª…ë‹¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    // ì„ì‹œë¡œ ê°„ë‹¨í•œ ì•Œë¦¼ ì²˜ë¦¬
                    seat.classList.add('border-red-500');
                    setTimeout(() => seat.classList.remove('border-red-500'), 1000);
                    return;
                }

                // 2. ëª¨ë‹¬ì— ì •ë³´ ì„¤ì •
                pinSeatIdInput.value = seatId;
                pinSeatLabel.textContent = seatLabel;

                // 3. í•™ìƒ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
                pinStudentSelect.innerHTML = '<option value="">-- í•™ìƒ ì„ íƒ --</option>';
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student;
                    option.textContent = student;
                    
                    // í˜„ì¬ ì´ ìë¦¬ì— ê³ ì •ëœ í•™ìƒì´ ìˆë‹¤ë©´ ê·¸ í•™ìƒì„ ê¸°ë³¸ ì„ íƒ
                    if (pinnedSeats[seatId] === student) {
                        option.selected = true;
                    }
                    pinStudentSelect.appendChild(option);
                });

                // 4. ëª¨ë‹¬ í‘œì‹œ
                pinModal.classList.remove('hidden');
            }

            /**
             * í•™ìƒ ê³ ì • ì²˜ë¦¬
             */
            function handlePinConfirm() {
                const seatId = pinSeatIdInput.value;
                const studentName = pinStudentSelect.value;
                const seatElement = document.getElementById(seatId);

                if (!seatElement) return;
                
                // í•™ìƒì„ ì„ íƒí•˜ì§€ ì•Šì€ ê²½ìš° (ê³ ì • í•´ì œì™€ ë™ì¼í•˜ê²Œ ì²˜ë¦¬)
                if (!studentName) {
                    handlePinRemove();
                    return;
                }

                // 1. ì´ í•™ìƒì´ ë‹¤ë¥¸ ìë¦¬ì— ì´ë¯¸ ê³ ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                const oldSeatId = Object.keys(pinnedSeats).find(id => pinnedSeats[id] === studentName);
                if (oldSeatId && oldSeatId !== seatId) {
                    // ì´ì „ ìë¦¬ì—ì„œ ê³ ì • í•´ì œ
                    const oldSeatElement = document.getElementById(oldSeatId);
                    if (oldSeatElement) {
                        clearSeatUI(oldSeatElement);
                    }
                    delete pinnedSeats[oldSeatId];
                }

                // 2. ì´ ìë¦¬ì— ë‹¤ë¥¸ í•™ìƒì´ ì´ë¯¸ ê³ ì •ë˜ì–´ ìˆì—ˆë‹¤ë©´, ê·¸ í•™ìƒ ì •ë³´ëŠ” ìë™ ì‚­ì œë¨
                
                // 3. ìƒˆ ìë¦¬-í•™ìƒ ê³ ì •
                pinnedSeats[seatId] = studentName;
                updateSeatUI(seatElement, studentName, true); // ê³ ì • UI ì—…ë°ì´íŠ¸

                pinModal.classList.add('hidden');
            }

            /**
             * íŠ¹ì • ì¢Œì„ì˜ ê³ ì • í•´ì œ
             */
            function handlePinRemove() {
                const seatId = pinSeatIdInput.value;
                const seatElement = document.getElementById(seatId);

                if (seatElement && pinnedSeats[seatId]) {
                    delete pinnedSeats[seatId];
                    clearSeatUI(seatElement);
                }
                pinModal.classList.add('hidden');
            }

            /**
             * ì¢Œì„ UIë¥¼ ê³ ì • ìƒíƒœë¡œ ì—…ë°ì´íŠ¸
             */
            function updateSeatUI(seatElement, studentName, isPinned) {
                if (!seatElement) return;
                
                seatElement.querySelector('.student-name').textContent = studentName;
                const pinIcon = seatElement.querySelector('.pin-icon');

                if (isPinned) {
                    seatElement.classList.add('pinned');
                    pinIcon.classList.remove('hidden');
                } else {
                    seatElement.classList.remove('pinned');
                    pinIcon.classList.add('hidden');
                }
            }

            /**
             * ì¢Œì„ UIë¥¼ ê¸°ë³¸ ìƒíƒœë¡œ ì´ˆê¸°í™”
             */
            function clearSeatUI(seatElement) {
                if (!seatElement) return;
                seatElement.querySelector('.student-name').textContent = "---";
                seatElement.classList.remove('pinned');
                seatElement.querySelector('.pin-icon').classList.add('hidden');
            }


            /**
             * í•™ìƒë“¤ì„ ë¹ˆ ìë¦¬ì— ëœë¤ ë°°ì¹˜
             */
            function assignSeats() {
                parseStudentList();
                
                const allSeatElements = document.querySelectorAll('.seat');
                if (allSeatElements.length === 0) {
                    // alert('ë¨¼ì € "êµì‹¤ ë°°ì¹˜ ìƒì„±"ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
                    console.warn('ë¨¼ì € "êµì‹¤ ë°°ì¹˜ ìƒì„±"ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
                    return;
                }

                if (students.length === 0) {
                    // alert('ë¨¼ì € "í•™ìƒ ëª…ë‹¨"ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    console.warn('ë¨¼ì € "í•™ìƒ ëª…ë‹¨"ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                // 1. ê³ ì •ë˜ì§€ ì•Šì€ í•™ìƒ ëª©ë¡
                const pinnedStudentNames = Object.values(pinnedSeats);
                const unpinnedStudents = students.filter(s => !pinnedStudentNames.includes(s));

                // 2. ê³ ì •ë˜ì§€ ì•Šì€ ì¢Œì„ ëª©ë¡
                const availableSeats = [];
                allSeatElements.forEach(seat => {
                    if (!pinnedSeats[seat.id]) {
                        availableSeats.push(seat);
                        // ëœë¤ ë°°ì¹˜ ì „, ì´ì „ì— ë°°ì¹˜ëë˜ ì´ë¦„ ì´ˆê¸°í™”
                        clearSeatUI(seat);
                    }
                });
                
                // 3. í•™ìƒ ëª©ë¡ ì…”í”Œ (Fisher-Yates Shuffle)
                const shuffledStudents = [...unpinnedStudents];
                for (let i = shuffledStudents.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledStudents[i], shuffledStudents[j]] = [shuffledStudents[j], shuffledStudents[i]];
                }

                // 4. ì¢Œì„ì— í•™ìƒ ë°°ì¹˜
                availableSeats.forEach((seat, index) => {
                    const studentName = shuffledStudents[index];
                    if (studentName) {
                        updateSeatUI(seat, studentName, false); // ê³ ì • ì•„ë‹˜ UI
                    } else {
                        // í•™ìƒ ìˆ˜ë³´ë‹¤ ìë¦¬ê°€ ë§ìœ¼ë©´ ë¹ˆ ìë¦¬ë¡œ ë‘ 
                        clearSeatUI(seat);
                    }
                });

                // 5. ê²½ê³  ë©”ì‹œì§€
                if (shuffledStudents.length > availableSeats.length) {
                    // alert('ìë¦¬ê°€ ë¶€ì¡±í•˜ì—¬ ì¼ë¶€ í•™ìƒì´ ë°°ì¹˜ë˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    console.warn('ìë¦¬ê°€ ë¶€ì¡±í•˜ì—¬ ì¼ë¶€ í•™ìƒì´ ë°°ì¹˜ë˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            /**
             * ëª¨ë“  ì„¤ì • ì´ˆê¸°í™”
             */
            function resetAll() {
                rowsInput.value = "5";
                colsInput.value = "6";
                studentList.value = "";
                students = [];
                pinnedSeats = {};
                seatGrid.innerHTML = '<p class="text-gray-500 text-center col-span-full">ì„¤ì •ì—ì„œ "êµì‹¤ ë°°ì¹˜ ìƒì„±" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>';
                teacherViewToggle.checked = false;
                seatingChartArea.classList.remove('teachers-view');
            }

            /**
             * ì„ ìƒë‹˜ìš© ë³´ê¸° (ìƒí•˜ ë°˜ì „) í† ê¸€
             */
            function toggleTeacherView() {
                if (teacherViewToggle.checked) {
                    seatingChartArea.classList.add('teachers-view');
                } else {
                    seatingChartArea.classList.remove('teachers-view');
                }
            }

            /**
             * ìë¦¬ ë°°ì¹˜ë„ë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ
             */
            async function downloadAsPdf() {
                if (typeof html2canvas === 'undefined' || typeof jsPDF === 'undefined') {
                    // alert('PDF ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
                    console.error('PDF ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }

                downloadPdfBtn.textContent = 'PDF ìƒì„± ì¤‘...';
                downloadPdfBtn.disabled = true;

                try {
                    // 1. html2canvasë¡œ ë°°ì¹˜ë„ ì˜ì—­ì„ ìº¡ì²˜ (ê³ í•´ìƒë„ë¥¼ ìœ„í•´ scale 2 ì ìš©)
                    const canvas = await html2canvas(seatingChartArea, { 
                        scale: 2,
                        backgroundColor: '#ffffff' // ìº¡ì²˜ ì˜ì—­ ë°°ê²½ì„ í°ìƒ‰ìœ¼ë¡œ ì§€ì •
                    });
                    
                    // 2. ìº¡ì²˜í•œ ì´ë¯¸ì§€ë¥¼ data URLë¡œ ë³€í™˜
                    const imgData = canvas.toDataURL('image/png');

                    // 3. jsPDFë¡œ A4 ìš©ì§€(ì„¸ë¡œ) ìƒì„±
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    // 4. ì´ë¯¸ì§€ì˜ ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©´ì„œ A4 ìš©ì§€ì— ë§ê²Œ í¬ê¸° ê³„ì‚°
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = Math.min((pdfWidth - 20) / imgWidth, (pdfHeight - 20) / imgHeight); // ìƒí•˜ì¢Œìš° 10mm ì—¬ë°±
                    
                    const finalImgWidth = imgWidth * ratio;
                    const finalImgHeight = imgHeight * ratio;

                    // 5. ì´ë¯¸ì§€ë¥¼ PDF ì¤‘ì•™ì— ë°°ì¹˜
                    const imgX = (pdfWidth - finalImgWidth) / 2;
                    const imgY = 10; // ìƒë‹¨ ì—¬ë°± 10mm

                    pdf.addImage(imgData, 'PNG', imgX, imgY, finalImgWidth, finalImgHeight);
                    
                    // 6. PDF ì €ì¥
                    pdf.save('seating_chart.pdf');

                } catch (error) {
                    console.error('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                    // alert('PDFë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                } finally {
                    // 7. ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
                    downloadPdfBtn.textContent = '3. PDFë¡œ ë‹¤ìš´ë¡œë“œ';
                    downloadPdfBtn.disabled = false;
                }
            }
        });
    </script>

</body>
</html>